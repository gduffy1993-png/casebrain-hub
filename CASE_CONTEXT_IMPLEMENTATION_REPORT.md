# Case Context Implementation Report

## Overview
Implemented "One Brain / One Context" architecture to eliminate org_id mismatches and prevent "jumble mumble" outputs. All routes now read from a single canonical context builder.

## Files Changed

### New Files
1. **`lib/case-context.ts`** (NEW)
   - Single function `buildCaseContext(caseId, authContext)` that resolves org scope, finds case, finds documents, and computes diagnostics
   - Returns `CaseContext` with case, orgScope, documents, diagnostics, and optional banner

### Modified Files
1. **`app/api/cases/[caseId]/key-facts/route.ts`**
   - Refactored to use `buildCaseContext` instead of direct lookups
   - Implements 4 gates: CASE_NOT_FOUND → DOCS_NONE → SCANNED_SUSPECTED/TEXT_THIN → OK
   - Facts-first gating: does NOT generate Key Facts if text is too thin

2. **`app/api/cases/[caseId]/insights/route.ts`**
   - Refactored to use `buildCaseContext` instead of direct lookups
   - Implements 4 gates: CASE_NOT_FOUND → DOCS_NONE → SCANNED_SUSPECTED/TEXT_THIN → OK
   - Facts-first gating: does NOT generate strategy/insights if text is too thin

3. **`app/api/cases/[caseId]/summary/route.ts`**
   - Refactored to use `buildCaseContext` instead of `requireAuthContext`
   - Implements 4 gates: CASE_NOT_FOUND → DOCS_NONE → SCANNED_SUSPECTED/TEXT_THIN → OK
   - Returns banner and diagnostics when gates trigger

## Reason Codes

The system uses the following reason codes (in `context.diagnostics.reasonCodes`):

- **`CASE_NOT_FOUND`**: Case not found in resolved org scope
- **`DOCS_NONE`**: Case found but no documents exist
- **`SCANNED_SUSPECTED`**: Documents exist but rawCharsTotal < 800 AND jsonCharsTotal < 400 (suspected scanned PDF)
- **`TEXT_THIN`**: Documents exist but rawCharsTotal < 800 (insufficient text, but not necessarily scanned)
- **`OK`**: Case found, documents exist, and text is sufficient

## Thresholds

**Scanned PDF Detection:**
- `suspectedScanned = true` if: `docCount > 0 AND rawCharsTotal < 800 AND jsonCharsTotal < 400`
- Reason code: `SCANNED_SUSPECTED`

**Thin Text Detection:**
- `textThin = true` if: `docCount > 0 AND rawCharsTotal < 800` (but jsonCharsTotal >= 400)
- Reason code: `TEXT_THIN`

**Average Characters Per Document:**
- `avgRawCharsPerDoc = Math.floor(rawCharsTotal / docCount)` when `docCount > 0`
- Otherwise: `0`

## Gating Logic (Facts-First)

All routes implement the same 4-gate system:

**Gate 1: Case Exists?**
- If `CASE_NOT_FOUND` → Return fallback payload with banner, stop
- Status: 200 (not 404)

**Gate 2: Documents Exist?**
- If `DOCS_NONE` → Return minimal payload with banner, stop
- Still generates Key Facts/Insights from case data only

**Gate 3: Extractable Text?**
- If `SCANNED_SUSPECTED` OR `TEXT_THIN` → Return minimal payload with banner, **DO NOT generate Key Facts/Insights/Strategy**
- This prevents "jumble mumble" outputs

**Gate 4: OK**
- If `OK` → Proceed to generate full Key Facts/Insights/Summary
- Only reaches here if all previous gates pass

## Org Scope Resolution

The context builder resolves org scope using one of three methods:

1. **`org_uuid`**: Case's org_id matches orgScope.orgId (UUID from organisations table)
2. **`solo_fallback`**: Case's org_id matches orgScope.externalRef (legacy `solo-user_${userId}` format)
3. **`owner_override`**: Case's org_id doesn't match either (edge case, but still valid)

All document queries use `context.orgScope.orgIdResolved` to ensure consistency.

## Banner Structure

Banners are returned in responses with this structure:
```typescript
{
  severity: "warning" | "error" | "info",
  title?: string,
  message: string
}
```

Banners are automatically generated by `buildCaseContext` based on reason codes, but routes can override with custom banners if needed.

## How to Reproduce

### Test Case 1: Scanned PDF
1. Upload a scanned/image-only PDF (no extractable text)
2. Expected behavior:
   - `diagnostics.suspectedScanned = true`
   - `reasonCodes` includes `SCANNED_SUSPECTED`
   - Banner: "No extractable text detected - This PDF appears scanned/image-only..."
   - Key Facts: Minimal fallback (does NOT generate full Key Facts)
   - Insights: Minimal fallback (does NOT generate strategy)

### Test Case 2: Text PDF
1. Upload a text-based PDF with substantial content
2. Expected behavior:
   - `diagnostics.rawCharsTotal >= 800`
   - `reasonCodes` includes `OK`
   - No banner (unless other issues)
   - Key Facts: Full generation
   - Insights: Full generation

### Test Case 3: No Documents
1. Create a case but don't upload any documents
2. Expected behavior:
   - `diagnostics.docCount = 0`
   - `reasonCodes` includes `DOCS_NONE`
   - Banner: "No documents found - Upload documents to generate full analysis"
   - Key Facts: Generated from case data only
   - Insights: Generated from case data only

### Test Case 4: Case Not Found
1. Try to access a case that doesn't exist or belongs to different org
2. Expected behavior:
   - `reasonCodes` includes `CASE_NOT_FOUND`
   - Banner: "Case not found for your org scope..."
   - All routes return fallback payloads with banner

## Server Logs

The system logs gate triggers and diagnostics:
- `[case-context] caseId=..., method=..., reasonCodes=[...], docCount=..., rawChars=..., jsonChars=...`
- `[key-facts] Gate triggered: SCANNED_SUSPECTED for caseId=..., rawChars=..., jsonChars=...`
- `[insights] Gate triggered: TEXT_THIN for caseId=..., rawChars=...`
- `[case-summary] Gate triggered: DOCS_NONE for caseId=...`

## Backward Compatibility

- All response shapes remain backward compatible
- Existing `keyFacts` and `insights` fields unchanged
- New optional fields: `banner` and `diagnostics`
- UI components already support banners (no changes needed)

## Deterministic Behavior

- Same inputs → same outputs
- No random behavior
- No hallucination (if text is thin, we say so explicitly)
- All routes use the same context, so they see the same data

## Next Steps (Not Implemented)

- Other routes (criminal, strategic, etc.) can be refactored to use `buildCaseContext` in future
- No UI changes needed (banners already supported)
- No new panels or layouts
